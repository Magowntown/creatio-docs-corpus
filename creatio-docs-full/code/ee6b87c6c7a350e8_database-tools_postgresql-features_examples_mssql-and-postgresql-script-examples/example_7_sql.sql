-- Recursive stored procedure that returns a table and uses PERFORM:-- PostgreSQLDROP FUNCTION IF EXISTS "tsp_GetAdminUnitList";CREATE FUNCTION "tsp_GetAdminUnitList"(    UserId UUID,    IsGranted BOOLEAN = FALSE,    NestLevel INT = 0)RETURNS TABLE (    "Id" UUID,    "Name" VARCHAR(250),    "ParentRoleId" UUID)AS $$DECLARE    ConnectionType INT;    IsAdminUnitListTempExists BOOLEAN = FALSE;    DependentUserId UUID;    DependentUsersList CURSOR FOR        SELECT            "AdminUnitList"."Id"        FROM            "AdminUnitList"        INNER JOIN "SysAdminUnit" ON "AdminUnitList"."Id" = "SysAdminUnit"."Id"        WHERE            "SysAdminUnit"."SysAdminUnitTypeValue" = 4            AND "AdminUnitList"."Id" <> UserId            AND "AdminUnitList"."Granted" = FALSE            AND "AdminUnitList"."Level" >= NestLevel;    GrantorSysAdminUnitId UUID;    GetGrantorSysAdminUnitList CURSOR FOR        SELECT            "GrantorSysAdminUnitId" AS "Id"        FROM            "SysAdminUnitGrantedRight"        WHERE            "GranteeSysAdminUnitId" = UserId            AND NOT EXISTS (                SELECT *                FROM "AdminUnitList"                WHERE "AdminUnitList"."Id" = UserId                    AND "AdminUnitList"."Granted" = TRUE                    AND "AdminUnitList"."Level" < NestLevel            );    ParentRoleId UUID = NULL;BEGIN    IF NestLevel = 0 THEN        CREATE TEMPORARY TABLE IF NOT EXISTS "AdminUnitList" (            "Id" UUID,            "Name" VARCHAR(250),            "ParentRoleId" UUID,            "Granted" BOOLEAN,            "Level" INT        );        TRUNCATE TABLE "AdminUnitList";    END IF;    SELECT "ConnectionType" INTO ConnectionType FROM "SysAdminUnit" WHERE "SysAdminUnit"."Id" = UserId;    WITH RECURSIVE "MainSelect" AS (        SELECT            "SysAdminUnit"."Id" "Id",            "SysAdminUnit"."Name" "Name",            "SysAdminUnit"."ParentRoleId" "ParentRoleId"        FROM            "SysAdminUnit"        WHERE            ("SysAdminUnitTypeValue" <= 4 OR "SysAdminUnitTypeValue" = 6)        AND "ConnectionType" = ConnectionType        UNION ALL        SELECT            "SysAdminUnit"."Id" "Id",            "SysAdminUnit"."Name" "Name",            "SysAdminUnit"."ParentRoleId" "ParentRoleId"        FROM            "SysAdminUnit"        WHERE            "SysAdminUnit"."Id" = UserId),        "ChiefUnitsSelect" AS (            SELECT                "chief"."ParentRoleId" "Id"            FROM                "SysUserInRole" AS "userInRole"                INNER JOIN "SysAdminUnit" AS "sau" ON ("sau"."Id" = "userInRole"."SysUserId")                INNER JOIN "SysAdminUnit" AS "chief" ON ("chief"."Id" = "userInRole"."SysRoleId")            WHERE                "sau"."Id" = UserId                AND "userInRole"."SysRoleId" IS NOT NULL                AND "chief"."SysAdminUnitTypeValue" = 2            UNION ALL            SELECT                "chief"."ParentRoleId" "Id"            FROM                "SysAdminUnit" "chief"            WHERE                "chief"."Id" = UserId AND "chief"."SysAdminUnitTypeValue" = 2            UNION ALL            SELECT                "sau"."Id"            FROM                "ChiefUnitsSelect"                INNER JOIN "SysAdminUnit" "sau" ON ("sau"."ParentRoleId" = "ChiefUnitsSelect"."Id")            WHERE                "sau"."SysAdminUnitTypeValue" < 4        ),        "HierarchicalSelect" AS (            SELECT                "SelectStartLevel"."Id",                "SelectStartLevel"."Name",                "SelectStartLevel"."ParentRoleId",                0 "Level"            FROM                "MainSelect" "SelectStartLevel"            WHERE                "SelectStartLevel"."Id" IN (                    SELECT                        "userInRole"."SysRoleId"                    FROM                        "SysUserInRole" AS "userInRole"                        INNER JOIN "SysAdminUnit" AS "sau" ON ("sau"."Id" = "userInRole"."SysUserId")                    WHERE                        "sau"."Id" = UserId                    UNION ALL                    SELECT "ChiefUnitsSelect"."Id"                    FROM "ChiefUnitsSelect"                    UNION ALL                    SELECT                        "SysAdminUnit"."Id"                    FROM                        "SysAdminUnit"                    WHERE                        ("SysAdminUnit"."ParentRoleId" IS NULL OR "SysAdminUnit"."Id" = UserId)                        AND "SysAdminUnitTypeValue" < 4                    UNION ALL                    SELECT                        "FuncRoleId"                    FROM                        "SysFuncRoleInOrgRole"                    WHERE                        "SysFuncRoleInOrgRole"."OrgRoleId" = UserId                    )            UNION ALL            SELECT                "SelectPriorLevel"."Id",                "SelectPriorLevel"."Name",                "SelectPriorLevel"."ParentRoleId",                "Level" + 1 "level"            FROM                "MainSelect" "SelectPriorLevel"                INNER JOIN "HierarchicalSelect" AS "hierSelect" ON ("hierSelect"."ParentRoleId" = "SelectPriorLevel"."Id")        ),        "FuncRoleHierarchicalSelect" AS (            SELECT                "StartLevel"."Id",                "StartLevel"."Name",                "StartLevel"."ParentRoleId",                0 "Level"            FROM                "MainSelect" "StartLevel"            WHERE EXISTS (                SELECT NULL                FROM "SysFuncRoleInOrgRole" AS "funcRoleInOrgRole"                    INNER JOIN "HierarchicalSelect" AS "hierSelect" ON "funcRoleInOrgRole"."OrgRoleId" = "hierSelect"."Id"                WHERE "funcRoleInOrgRole"."FuncRoleId" = "StartLevel"."Id"            )            UNION ALL            SELECT                "PriorLevel"."Id",                "PriorLevel"."Name",                "PriorLevel"."ParentRoleId",                "Level" + 1 "level"            FROM                "MainSelect" "PriorLevel"                INNER JOIN "FuncRoleHierarchicalSelect" AS "funcRoleHierSelect" ON ("funcRoleHierSelect"."ParentRoleId" = "PriorLevel"."Id")        ),        "DependentUserSelect" AS (            SELECT                "mainSelect"."Id" "Id",                "mainSelect"."Name" "Name",                "mainSelect"."ParentRoleId" "ParentRoleId",                0 "Level"            FROM                "MainSelect" AS "mainSelect"            INNER JOIN "SysUserInRole" AS "userInRole"                ON "mainSelect"."Id" = "userInRole"."SysUserId"            INNER JOIN "ChiefUnitsSelect" AS "AllUnits"                ON "AllUnits"."Id" = "userInRole"."SysRoleId"            WHERE                NOT EXISTS (                        SELECT                            "UserUnits"."Id"                        FROM "ChiefUnitsSelect" AS "UserUnits"                        INNER JOIN "SysUserInRole" AS "UserInRole"                            ON "UserUnits"."Id" = "UserInRole"."SysRoleId"                        INNER JOIN "SysAdminUnit" AS "sau"                            ON "sau"."Id" = "UserUnits"."Id"                        WHERE "sau"."SysAdminUnitTypeValue" = 2                            AND "UserInRole"."SysUserId" = UserId                            AND "UserUnits"."Id" = "AllUnits"."Id")        )        INSERT INTO "AdminUnitList" ("Id", "Name", "ParentRoleId", "Granted", "Level")        SELECT DISTINCT            "AdminUnitList"."Id",            "AdminUnitList"."Name",            "AdminUnitList"."ParentRoleId",            IsGranted,            NestLevel        FROM (            SELECT                "HierarchicalSelect"."Id",                "HierarchicalSelect"."Name",                "HierarchicalSelect"."ParentRoleId"            FROM "HierarchicalSelect"            UNION ALL            SELECT                "SysAdminUnit"."Id",                "SysAdminUnit"."Name",                "SysAdminUnit"."ParentRoleId"            FROM "SysAdminUnit"            WHERE                "SysAdminUnit"."Id" = UserId            UNION ALL            SELECT                "FuncRoleHierarchicalSelect"."Id",                "FuncRoleHierarchicalSelect"."Name",                "FuncRoleHierarchicalSelect"."ParentRoleId"            FROM "FuncRoleHierarchicalSelect"            UNION ALL            SELECT                "DependentUserSelect"."Id",                "DependentUserSelect"."Name",                "DependentUserSelect"."ParentRoleId"            FROM "DependentUserSelect"        ) AS "AdminUnitList";    DependentUsersList := 'DependentUsersList' || NestLevel ;    FOR DependentUser IN DependentUsersList LOOP        EXIT WHEN DependentUser = NULL;        DependentUserId = DependentUser."Id";        PERFORM "tsp_GetAdminUnitList"(DependentUserId, 1, NestLevel + 1);    END LOOP;    GetGrantorSysAdminUnitList := 'GetGrantorSysAdminUnitList' || NestLevel ;    FOR GrantorSysAdminUnit IN GetGrantorSysAdminUnitList LOOP        EXIT WHEN GrantorSysAdminUnit = NULL;        GrantorSysAdminUnitId = GrantorSysAdminUnit."Id";        PERFORM "tsp_GetAdminUnitList"(GrantorSysAdminUnitId, 1, NestLevel + 1);    END LOOP;    IF NestLevel = 0 THEN        RETURN QUERY        SELECT "QQ"."Id",                "QQ"."Name",                "QQ"."ParentRoleId"        FROM (            SELECT DISTINCT                "AdminUnitList"."Id",                "AdminUnitList"."Name",                "AdminUnitList"."ParentRoleId",                "sau"."SysAdminUnitTypeValue"            FROM "AdminUnitList"            INNER JOIN "SysAdminUnit" AS "sau" ON "sau"."Id" = "AdminUnitList"."Id") AS "QQ"        ORDER BY "QQ"."SysAdminUnitTypeValue" DESC;    END IF;END;$$ LANGUAGE plpgsql;