-- Stored procedure that uses loops, cursors, and temporary tables-- PostgreSQLDROP FUNCTION IF EXISTS "tsp_ActualizeUserRoles";CREATE FUNCTION "tsp_ActualizeUserRoles"(    UserId UUID)RETURNS VOIDAS $$DECLARE    getUserNewManagers CURSOR FOR        SELECT DISTINCT "Id" FROM (            SELECT "Id" FROM "NewManagers"            UNION            SELECT "GranteeSysAdminUnitId"            FROM "SysAdminUnitGrantedRight"            WHERE EXISTS (                SELECT NULL FROM "NewManagers" as "newManagers"                WHERE "SysAdminUnitGrantedRight"."GrantorSysAdminUnitId" = "newManagers"."Id"            )        ) "Roles";    lostUserRolesCount INT;    getUserStillManagers CURSOR FOR        SELECT DISTINCT "stillManagers"."Id" AS "Id"        FROM "StillManagers" AS "stillManagers"        UNION        SELECT "GranteeSysAdminUnitId"        FROM "SysAdminUnitGrantedRight"        WHERE EXISTS (            SELECT NULL            FROM "StillManagers" AS "stillManagers"            WHERE "stillManagers"."Id" = "GrantorSysAdminUnitId"        );    getUserNoLongerManagers CURSOR FOR        SELECT DISTINCT "Id" FROM (            SELECT "Id"            FROM "NoLongerManagers"            UNION            SELECT "GranteeSysAdminUnitId"            FROM "SysAdminUnitGrantedRight"            WHERE EXISTS (                SELECT NULL                FROM "NoLongerManagers" AS "noLongerManagers"                WHERE "noLongerManagers"."Id" = "GrantorSysAdminUnitId"            )            UNION ALL            SELECT "GranteeSysAdminUnitId"            FROM "SysAdminUnitGrantedRight"            WHERE "GrantorSysAdminUnitId" = UserId        ) "Roles";BEGIN    DROP TABLE IF EXISTS "GetAdminUnitListTmp";    CREATE TEMP TABLE "GetAdminUnitListTmp" (        "Id" UUID,        "Name" VARCHAR(250),        "ParentRoleId" UUID    );    DROP TABLE IF EXISTS "SysAdminUnitRoles";    CREATE TEMP TABLE "SysAdminUnitRoles" (        "Id" UUID,        "Name" VARCHAR(250),        "ParentRoleId" UUID    );    -- Old user roles    DROP TABLE IF EXISTS "OldUserRoles";    CREATE TEMP TABLE "OldUserRoles" (        "Id" UUID    );    INSERT INTO "OldUserRoles"        SELECT DISTINCT "SysAdminUnitInRole"."SysAdminUnitRoleId" "Id"        FROM "SysAdminUnitInRole"        WHERE "SysAdminUnitInRole"."SysAdminUnitId" = UserId;    -- Old user managers    DROP TABLE IF EXISTS "ManagersBeforeActualization";    CREATE TEMP TABLE "ManagersBeforeActualization" (        "Id" UUID    );    INSERT INTO "ManagersBeforeActualization"        SELECT DISTINCT "SysUserInRole"."SysUserId" "Id"        FROM "SysAdminUnitInRole"        INNER JOIN "SysAdminUnit" "Roles"            ON "SysAdminUnitInRole"."SysAdminUnitRoleId" = "Roles"."Id"        INNER JOIN "OldUserRoles"            ON "Roles"."ParentRoleId" = "OldUserRoles"."Id"        INNER JOIN "SysUserInRole"            ON "SysUserInRole"."SysRoleId" = "Roles"."Id"        WHERE "Roles"."SysAdminUnitTypeValue" = 2;    -- Get and insert new user roles    DROP TABLE IF EXISTS "GetAdminUnitList";    CREATE TEMP TABLE "GetAdminUnitList" (        "Id" UUID,        "Name" VARCHAR(250),        "ParentRoleId" UUID    );    DROP TABLE IF EXISTS "NewRoles";    CREATE TEMP TABLE "NewRoles" (        "Id" UUID    );    INSERT INTO "GetAdminUnitList" SELECT * FROM "tsp_GetAdminUnitList"(UserId);    INSERT INTO "NewRoles" SELECT "Id" FROM "GetAdminUnitList";    DELETE FROM "SysAdminUnitInRole" WHERE "SysAdminUnitId" = UserId;    INSERT INTO "SysAdminUnitInRole" ("SysAdminUnitId", "SysAdminUnitRoleId")        SELECT DISTINCT UserId, "Id" FROM "NewRoles";    -- User managers after actualization    DROP TABLE IF EXISTS "ManagersAfterActualization";    CREATE TEMP TABLE "ManagersAfterActualization" (        "Id" UUID    );    INSERT INTO "ManagersAfterActualization"        SELECT DISTINCT            "SysUserInRole"."SysUserId" "Id"        FROM "SysAdminUnitInRole"        INNER JOIN "SysAdminUnit" "Roles"            ON "SysAdminUnitInRole"."SysAdminUnitRoleId" = "Roles"."Id"        INNER JOIN "NewRoles" "NewRoles"            ON "Roles"."ParentRoleId" = "NewRoles"."Id"        INNER JOIN "SysUserInRole"            ON "SysUserInRole"."SysRoleId" = "Roles"."Id"        WHERE "Roles"."SysAdminUnitTypeValue" = 2;    -- New (who were not but become) user managers    DROP TABLE IF EXISTS "NewManagers";    CREATE TEMP TABLE "NewManagers" (        "Id" UUID    );    INSERT INTO "NewManagers"        SELECT "Id" FROM "ManagersAfterActualization" AS "managersAfterActualization"            WHERE NOT EXISTS (                SELECT NULL                FROM "ManagersBeforeActualization" AS "managersBeforeActualization"                WHERE "managersBeforeActualization"."Id" = "managersAfterActualization"."Id"            );    -- Add all user roles to new managers and their grantee-users, if they arent already have    FOR UserNewManager IN getUserNewManagers LOOP        EXIT WHEN UserNewManager = NULL;        INSERT INTO "SysAdminUnitInRole" ("SysAdminUnitId", "SysAdminUnitRoleId")            SELECT DISTINCT UserNewManager."Id", "Id"            FROM "NewRoles" AS "newRoles"            WHERE NOT EXISTS (                SELECT 1                FROM "SysAdminUnitInRole"                WHERE "SysAdminUnitInRole"."SysAdminUnitId" = UserNewManager."Id"                AND "SysAdminUnitInRole"."SysAdminUnitRoleId" = "newRoles"."Id"            );    END LOOP;    SELECT COUNT(*) INTO lostUserRolesCount    FROM "OldUserRoles" AS "oldUserRoles"    WHERE NOT EXISTS (        SELECT 1        FROM "NewRoles" AS "newUserRoles"        WHERE "newUserRoles"."Id" = "oldUserRoles"."Id"    );    -- Still (who were and remained) user managers    DROP TABLE IF EXISTS "StillManagers";    CREATE TEMP TABLE "StillManagers" (        "Id" UUID    );    INSERT INTO "StillManagers"        SELECT DISTINCT "managersAfterActualization"."Id" AS "Id"        FROM "ManagersAfterActualization" AS "managersAfterActualization"            JOIN "ManagersBeforeActualization" AS "managersBeforeActualization"                ON "managersAfterActualization"."Id" = "managersBeforeActualization"."Id";    -- If user lost at least one role, we need to actualize all his still-managers.    -- If not (user only gained new roles) - we just add to still-managers and their grantee-users new user roles.    IF lostUserRolesCount = 0 THEN        -- Add all new user roles to his still-managers and to their grantee-users        FOR UserStillManager IN getUserStillManagers LOOP            EXIT WHEN UserStillManager = NULL;            INSERT INTO "SysAdminUnitInRole" ("SysAdminUnitId", "SysAdminUnitRoleId")                SELECT DISTINCT UserStillManager."Id", "Id"                FROM "NewRoles" AS "newRoles"                WHERE NOT EXISTS (                    SELECT 1                    FROM "SysAdminUnitInRole"                    WHERE "SysAdminUnitInRole"."SysAdminUnitId" = UserStillManager."Id"                        AND "SysAdminUnitInRole"."SysAdminUnitRoleId" = "newRoles"."Id"                );        END LOOP;    ELSE        --Actualize all roles for still-managers        FOR UserStillManager IN getUserStillManagers LOOP            EXIT WHEN UserStillManager = NULL;            DELETE FROM "SysAdminUnitRoles";            INSERT INTO "SysAdminUnitRoles"                SELECT * FROM "tsp_GetAdminUnitList"(UserStillManager."Id");                DELETE FROM "SysAdminUnitInRole" WHERE "SysAdminUnitId" = UserStillManager."Id";                INSERT INTO "SysAdminUnitInRole" ("SysAdminUnitId", "SysAdminUnitRoleId")                    SELECT UserStillManager."Id", "Id" FROM "SysAdminUnitRoles";        END LOOP;    END IF;    -- No longer (who were but not remained) user managers    DROP TABLE IF EXISTS "NoLongerManagers";    CREATE TEMP TABLE "NoLongerManagers" (        "Id" UUID    );    INSERT INTO "NoLongerManagers"        SELECT "Id" FROM "ManagersBeforeActualization" AS "managersBeforeActualization"            WHERE NOT EXISTS (                SELECT NULL                FROM "ManagersAfterActualization" AS "managersAfterActualization"                WHERE "managersAfterActualization"."Id" = "managersBeforeActualization"."Id"            );    -- Actualize roles for all noLonger-managers, his grantee-users and all grantee-users of user    FOR UserNoLongerManager IN getUserNoLongerManagers LOOP        EXIT WHEN UserNoLongerManager = NULL;        DELETE FROM "SysAdminUnitRoles";        INSERT INTO "SysAdminUnitRoles"            SELECT * FROM "tsp_GetAdminUnitList"(UserNoLongerManager."Id");            DELETE FROM "SysAdminUnitInRole"                WHERE "SysAdminUnitId" = UserNoLongerManager."Id";            INSERT INTO "SysAdminUnitInRole" ("SysAdminUnitId", "SysAdminUnitRoleId")                SELECT UserNoLongerManager."Id", "Id" FROM "SysAdminUnitRoles";    END LOOP;    DROP TABLE IF EXISTS "GetAdminUnitListTmp";END;$$ LANGUAGE plpgsql;