-- Recursive stored procedure that returns a table and uses PERFORM:-- MSSQLIF NOT OBJECT_ID('[dbo].[tsp_GetAdminUnitList]') IS NULLBEGIN    DROP PROCEDURE [dbo].[tsp_GetAdminUnitList];END;GOCREATE PROCEDURE dbo.tsp_GetAdminUnitList (    @UserId uniqueidentifier, @Granted BIT = 0)ASBEGIN    SET NOCOUNT ON;    DECLARE @StartNestedLevel INT;    IF object_id('tempdb..#AdminUnitList') IS NULL    BEGIN        CREATE TABLE [#AdminUnitList]        (            [Id] uniqueidentifier NOT NULL,            [Name] NVARCHAR(250) NULL,            [ParentRoleId] uniqueidentifier NULL,            [Granted] BIT NULL,            Level INT NOT NULL        );        SET @StartNestedLevel = @@NESTLEVEL;    END;    DECLARE @ConnectionType INT = (SELECT [ConnectionType] FROM SysAdminUnit WHERE [Id] = @UserId);    -- #AdminUnitListTemp should be created in tsp_ActualizeUserRoles or in tsp_ActualizeAdminUnitInRole    DECLARE @IsAdminUnitListTempExists BIT = OBJECT_ID('tempdb..#AdminUnitListTemp');    IF (@IsAdminUnitListTempExists IS NULL)    BEGIN        WITH        [MainSelect] AS (            SELECT                [Id] [Id],                [Name] [Name],                [ParentRoleId] [ParentRoleId]            FROM                [dbo].[SysAdminUnit]            WHERE                ([SysAdminUnitTypeValue] <= 4 OR [SysAdminUnitTypeValue] = 6)            AND [ConnectionType] = @ConnectionType            UNION ALL            SELECT                [Id] [Id],                [Name] [Name],                [ParentRoleId] [ParentRoleId]            FROM                [dbo].[SysAdminUnit]            WHERE                [Id] = @UserId),        [ChiefUnitsSelect] AS (            (                SELECT                    [Chief].[ParentRoleId] [Id]                FROM                    [dbo].[SysUserInRole] userInRole                    INNER JOIN [dbo].[SysAdminUnit] sau ON (sau.[Id] = userInRole.[SysUserId])                    INNER JOIN [dbo].[SysAdminUnit] [Chief] ON ([Chief].[Id] = userInRole.[SysRoleId])                WHERE                    sau.[Id] = @UserId AND NOT (userInRole.[SysRoleId] IS NULL) AND [Chief].[SysAdminUnitTypeValue] = 2                UNION ALL                SELECT                    [Chief].[ParentRoleId] [Id]                FROM                    [dbo].[SysAdminUnit] [Chief]                WHERE                    [Chief].[Id] = @UserId AND [Chief].[SysAdminUnitTypeValue] = 2            )            UNION ALL            SELECT                sau.[Id]            FROM                [ChiefUnitsSelect]                INNER JOIN [dbo].[SysAdminUnit] sau ON (sau.[ParentRoleId] = [ChiefUnitsSelect].[Id])            WHERE                sau.[SysAdminUnitTypeValue] < 4        ),        [HierarchicalSelect] AS (            SELECT                [Id],                [Name],                [ParentRoleId],                0 [Level]            FROM                [MainSelect] [SelectStartLevel]            WHERE                [Id] IN (                    SELECT                        userInRole.[SysRoleId]                    FROM                        [dbo].[SysUserInRole] userInRole                        INNER JOIN [dbo].[SysAdminUnit] sau ON (sau.[Id] = userInRole.[SysUserId])                    WHERE                        sau.[Id] = @UserId                    UNION ALL                    SELECT [Id] FROM [ChiefUnitsSelect]                    UNION ALL                    SELECT                        [Id]                    FROM                        [dbo].[SysAdminUnit]                    WHERE                        ([ParentRoleId] IS NULL OR [Id] = @UserId)                        AND [SysAdminUnitTypeValue] < 4                    UNION ALL                    SELECT                        [FuncRoleId]                    FROM                        [dbo].[SysFuncRoleInOrgRole]                    WHERE                        [SysFuncRoleInOrgRole].[OrgRoleId] = @UserId                    )            UNION ALL            SELECT                [SelectPriorLevel].[Id],                [SelectPriorLevel].[Name],                [SelectPriorLevel].[ParentRoleId],                [Level] + 1 level            FROM                [MainSelect] [SelectPriorLevel]                INNER JOIN [HierarchicalSelect] hierSelect ON (hierSelect.[ParentRoleId] = [SelectPriorLevel].[Id])        ),        [FuncRoleHierarchicalSelect] AS (            SELECT                [Id],                [Name],                [ParentRoleId],                0 [Level]            FROM                [MainSelect] [StartLevel]            WHERE EXISTS (                SELECT NULL                FROM [dbo].[SysFuncRoleInOrgRole] funcRoleInOrgRole                    INNER JOIN [HierarchicalSelect] hierSelect ON funcRoleInOrgRole.[OrgRoleId] = hierSelect.[Id]                WHERE funcRoleInOrgRole.[FuncRoleId] = [StartLevel].[Id]            )            UNION ALL            SELECT                [PriorLevel].[Id],                [PriorLevel].[Name],                [PriorLevel].[ParentRoleId],                [Level] + 1 level            FROM                [MainSelect] [PriorLevel]                INNER JOIN [FuncRoleHierarchicalSelect] funcRoleHierSelect ON (funcRoleHierSelect.[ParentRoleId] = [PriorLevel].[Id])        ),        [DependentUserSelect] AS (            SELECT                mainSelect.[Id] [Id],                mainSelect.[Name] [Name],                mainSelect.[ParentRoleId] [ParentRoleId],                0 [Level]            FROM                [MainSelect] mainSelect            INNER JOIN [SysUserInRole] userInRole                ON mainSelect.[Id] = userInRole.[SysUserId]            INNER JOIN [ChiefUnitsSelect] [AllUnits]                ON [AllUnits].[Id] = userInRole.[SysRoleId]            WHERE                NOT EXISTS (                        SELECT                            [UserUnits].[Id]                        FROM [ChiefUnitsSelect] [UserUnits]                        INNER JOIN [SysUserInRole] [UserInRole]                            ON [UserUnits].[Id] = [UserInRole].[SysRoleId]                        INNER JOIN [SysAdminUnit] sau                            ON sau.[Id] = [UserUnits].[Id]                        WHERE sau.[SysAdminUnitTypeValue] = 2                            AND [UserInRole].[SysUserId] = @UserId                            AND [UserUnits].[Id] = [AllUnits].[Id])        )        INSERT INTO [#AdminUnitList] ([Id], [Name], [ParentRoleId], [Granted], [Level])        SELECT DISTINCT            [Id],            [Name],            [ParentRoleId],            @Granted,            @@NESTLEVEL        FROM            (                SELECT                    [Id],                    [Name],                    [ParentRoleId]                FROM                    [HierarchicalSelect]                UNION ALL                SELECT                    [Id],                    [Name],                    [ParentRoleId]                FROM                    [dbo].[SysAdminUnit]                WHERE                    [Id] = @UserId            UNION ALL                SELECT                    [Id],                    [Name],                    [ParentRoleId]                FROM                    [FuncRoleHierarchicalSelect]            UNION ALL                SELECT                    [Id],                    [Name],                    [ParentRoleId]                FROM            [DependentUserSelect]        ) [AdminUnitList];    END ELSE    BEGIN        DECLARE @alreadyGotRolesForThisUser bit = 0;        IF (@IsAdminUnitListTempExists = 1)        BEGIN            SET @alreadyGotRolesForThisUser = (SELECT CAST( CASE WHEN EXISTS(SELECT 1 FROM [#AdminUnitListTemp]                    WHERE [UserId] = @UserId                    )                    THEN 1                    ELSE 0                END            AS BIT));        END;        IF (@alreadyGotRolesForThisUser = 1)        BEGIN            INSERT INTO [#AdminUnitList] ([Id], [Name], [ParentRoleId], [Granted], [Level])                SELECT DISTINCT                    [Id],                    [Name],                    [ParentRoleId],                    @Granted,                    @@NESTLEVEL                FROM [#AdminUnitListTemp] WHERE UserId = @UserId;        END ELSE        BEGIN            WITH            [MainSelect] AS (                SELECT                    [Id] [Id],                    [Name] [Name],                    [ParentRoleId] [ParentRoleId]                FROM                    [dbo].[SysAdminUnit]                WHERE                    ([SysAdminUnitTypeValue] <= 4 OR [SysAdminUnitTypeValue] = 6)                AND [ConnectionType] = @ConnectionType                UNION ALL                SELECT                    [Id] [Id],                    [Name] [Name],                    [ParentRoleId] [ParentRoleId]                FROM                    [dbo].[SysAdminUnit]                WHERE                    [Id] = @UserId),            [ChiefUnitsSelect] AS (                (                    SELECT                        [Chief].[ParentRoleId] [Id]                    FROM                        [dbo].[SysUserInRole] sysUserInRole                        INNER JOIN [dbo].[SysAdminUnit] sau ON (sau.[Id] = sysUserInRole.[SysUserId])                        INNER JOIN [dbo].[SysAdminUnit] [Chief] ON ([Chief].[Id] = sysUserInRole.[SysRoleId])                    WHERE                        sau.[Id] = @UserId AND NOT (sysUserInRole.[SysRoleId] IS NULL) AND [Chief].[SysAdminUnitTypeValue] = 2                    UNION ALL                    SELECT                        [Chief].[ParentRoleId] [Id]                    FROM                        [dbo].[SysAdminUnit] [Chief]                    WHERE                        [Chief].[Id] = @UserId AND [Chief].[SysAdminUnitTypeValue] = 2                )                UNION ALL                SELECT                    sau.[Id]                FROM                    [ChiefUnitsSelect] ChiefUnitsSelect                    INNER JOIN [dbo].[SysAdminUnit] sau ON (sau.[ParentRoleId] = [ChiefUnitsSelect].[Id])                WHERE                    sau.[SysAdminUnitTypeValue] < 4            ),            [HierarchicalSelect] AS (                SELECT                    [Id],                    [Name],                    [ParentRoleId],                    0 [Level]                FROM                    [MainSelect] [SelectStartLevel]                WHERE EXISTS (                    SELECT NULL                    FROM (                        SELECT [SysUserInRole].[SysRoleId] AS RoleId                        FROM [dbo].[SysUserInRole]                            INNER JOIN [dbo].[SysAdminUnit] ON ([SysAdminUnit].[Id] = [SysUserInRole].[SysUserId])                        WHERE [SysAdminUnit].[Id] = @UserId                        UNION ALL                        SELECT [Id] AS RoleId                        FROM [ChiefUnitsSelect]                        UNION ALL                        SELECT [Id] AS RoleId                        FROM [dbo].[SysAdminUnit]                        WHERE ([ParentRoleId] IS NULL OR [Id] = @UserId)                            AND [SysAdminUnitTypeValue] < 4                        UNION ALL                        SELECT [FuncRoleId] AS RoleId                        FROM [dbo].[SysFuncRoleInOrgRole]                        WHERE [SysFuncRoleInOrgRole].[OrgRoleId] = @UserId                    ) AS Roles                    WHERE Roles.RoleId = [SelectStartLevel].[Id]                )                UNION ALL                SELECT                    [SelectPriorLevel].[Id],                    [SelectPriorLevel].[Name],                    [SelectPriorLevel].[ParentRoleId],                    [Level] + 1 level                FROM                    [MainSelect] [SelectPriorLevel]                    INNER JOIN [HierarchicalSelect] hierSelect ON (hierSelect.[ParentRoleId] = [SelectPriorLevel].[Id])            ),            [FuncRoleHierarchicalSelect] AS (                SELECT                    [Id],                    [Name],                    [ParentRoleId],                    0 [Level]                FROM                    [MainSelect] [StartLevel]                WHERE EXISTS (                    SELECT NULL                    FROM [dbo].[SysFuncRoleInOrgRole] funcRoleInOrgRole                        INNER JOIN [HierarchicalSelect] hierSelect ON funcRoleInOrgRole.[OrgRoleId] = hierSelect.[Id]                    WHERE funcRoleInOrgRole.[FuncRoleId] = [StartLevel].[Id]                )                UNION ALL                SELECT                    [PriorLevel].[Id],                    [PriorLevel].[Name],                    [PriorLevel].[ParentRoleId],                    [Level] + 1                FROM                    [MainSelect] [PriorLevel]                    INNER JOIN [FuncRoleHierarchicalSelect] funcRolesHierSelect ON (funcRolesHierSelect.[ParentRoleId] = [PriorLevel].[Id])            ),            [DependentUserSelect] AS (                SELECT                    [MainSelect].[Id] [Id],                    [MainSelect].[Name] [Name],                    [MainSelect].[ParentRoleId] [ParentRoleId],                    0 [Level]                FROM                    [MainSelect]                INNER JOIN [SysUserInRole] sysUserInRole                    ON [MainSelect].[Id] = sysUserInRole.[SysUserId]                INNER JOIN [ChiefUnitsSelect] [AllUnits]                    ON [AllUnits].[Id] = sysUserInRole.[SysRoleId]                WHERE                    NOT EXISTS (                            SELECT                                [UserUnits].[Id]                            FROM [ChiefUnitsSelect] [UserUnits]                            INNER JOIN [SysUserInRole] [UserInRole]                                ON [UserUnits].[Id] = [UserInRole].[SysRoleId]                            INNER JOIN [SysAdminUnit] sau                                ON sau.[Id] = [UserUnits].[Id]                            WHERE sau.[SysAdminUnitTypeValue] = 2                                AND [UserInRole].[SysUserId] = @UserId                                AND [UserUnits].[Id] = [AllUnits].[Id])            )            INSERT INTO #AdminUnitListTemp ([UserId], [Id], [Name], [ParentRoleId], [Granted])            SELECT DISTINCT                @UserId,                [Id],                [Name],                [ParentRoleId],                @Granted            FROM                (                    SELECT                        [Id],                        [Name],                        [ParentRoleId]                    FROM                        [HierarchicalSelect]                    UNION ALL                    SELECT                        [Id],                        [Name],                        [ParentRoleId]                    FROM                        [dbo].[SysAdminUnit]                    WHERE                        [Id] = @UserId                UNION ALL                    SELECT                        [Id],                        [Name],                        [ParentRoleId]                    FROM                        [FuncRoleHierarchicalSelect]                UNION ALL                    SELECT                        [Id],                        [Name],                        [ParentRoleId]                    FROM                [DependentUserSelect]                ) [AdminUnitList];            INSERT INTO [#AdminUnitList] ([Id], [Name], [ParentRoleId], [Granted], [Level])            SELECT DISTINCT                [Id],                [Name],                [ParentRoleId],                @Granted,                @@NESTLEVEL            FROM [#AdminUnitListTemp] WHERE UserId = @UserId;        END;    END;    DECLARE @DependentUserId uniqueidentifier;    DECLARE @DependentUsersList CURSOR;    SET @DependentUsersList = CURSOR FOR        SELECT            [#AdminUnitList].[Id]        FROM            [#AdminUnitList]        INNER JOIN [SysAdminUnit] ON [#AdminUnitList].[Id] = [SysAdminUnit].[Id]        WHERE            [SysAdminUnit].[SysAdminUnitTypeValue] = 4 AND [#AdminUnitList].[Id] <> @UserId            AND [#AdminUnitList].[Granted] <> 1 AND [#AdminUnitList].[Level] >= @@NESTLEVEL;    OPEN @DependentUsersList;    FETCH NEXT    FROM @DependentUsersList INTO @DependentUserId;    WHILE @@FETCH_STATUS = 0    BEGIN        EXEC [tsp_GetAdminUnitList] @UserId=@DependentUserId, @Granted=1;    FETCH NEXT    FROM @DependentUsersList INTO @DependentUserId;    END;    CLOSE @DependentUsersList;    DEALLOCATE @DependentUsersList;    DECLARE @GrantorSysAdminUnitId uniqueidentifier;    DECLARE @getGrantorSysAdminUnitList CURSOR;    SET @getGrantorSysAdminUnitList = CURSOR FOR        SELECT            [GrantorSysAdminUnitId]        FROM            [dbo].[SysAdminUnitGrantedRight]        WHERE            [GranteeSysAdminUnitId] = @UserId            AND NOT EXISTS(SELECT * FROM [#AdminUnitList] WHERE [Id] = @UserId AND [Granted] = 1 AND [Level] < @@NESTLEVEL);    OPEN @getGrantorSysAdminUnitList;    FETCH NEXT    FROM @getGrantorSysAdminUnitList INTO @GrantorSysAdminUnitId;    WHILE @@FETCH_STATUS = 0    BEGIN        EXEC [tsp_GetAdminUnitList] @UserId=@GrantorSysAdminUnitId, @Granted=1;    FETCH NEXT    FROM @getGrantorSysAdminUnitList INTO @GrantorSysAdminUnitId;    END;    CLOSE @getGrantorSysAdminUnitList;    DEALLOCATE @getGrantorSysAdminUnitList;    IF @@NESTLEVEL = @StartNestedLevel    BEGIN        WITH QQ ([Id], [Name], [ParentRoleId], SysAdminUnitTypeValue) as (            SELECT DISTINCT adminUnitList.[Id],                adminUnitList.[Name],                adminUnitList.[ParentRoleId],                sau.SysAdminUnitTypeValue            FROM [#AdminUnitList] adminUnitList            INNER JOIN SysAdminUnit sau on sau.Id = adminUnitList.[Id]        )        SELECT [Id], [Name], [ParentRoleId] FROM QQ        ORDER BY SysAdminUnitTypeValue DESC;    END;END;GO