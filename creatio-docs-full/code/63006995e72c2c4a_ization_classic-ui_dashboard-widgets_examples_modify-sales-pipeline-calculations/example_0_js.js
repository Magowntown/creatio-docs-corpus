define("UsrFunnelByProductCountDataProvider", ["ext-base", "terrasoft", "UsrFunnelByProductCountDataProviderResources", "FunnelBaseDataProvider"], function(Ext, Terrasoft, resources) {    // Defining a new calculation provider.    Ext.define("Terrasoft.configuration.UsrFunnelByProductCountDataProvider", {        // Inheriting from the basic provider.        extend: "Terrasoft.FunnelBaseDataProvider",        // New provider short name        alternateClassName: "Terrasoft.UsrFunnelByProductCountDataProvider",        // Collection processing method        prepareFunnelResponseCollection: function(collection) {            this.callParent(arguments);        },        // Extending the FunnelBaseDataProvider base model method.         // Sets the column number of products for data sampling        addQueryColumns: function(entitySchemaQuery) {            // Parent method calling            this.callParent(arguments);            // Adds the number of products column to the sample            entitySchemaQuery.addAggregationSchemaColumn("[OpportunityProductInterest:Opportunity].Quantity",                    Terrasoft.AggregationType.SUM, "ProductsAmount");        },        // Extending the FunnelBaseDataProvider base class method.        // Sets sample filtration        applyFunnelPeriodFilters: function(filterGroup) {            // Parent method calling            this.callParent(arguments);            // Creates a filter group.            var endStageFilterGroup = Terrasoft.createFilterGroup();            // Sets the group operator type.            endStageFilterGroup.logicalOperation = Terrasoft.LogicalOperatorType.OR;            // Sets the filter that shows whether the sale stage is over yet.            endStageFilterGroup.addItem(                Terrasoft.createColumnIsNullFilter(this.getDetailColumnPath("DueDate")));            // Sets the filter that shows whether the sale stage is final.            endStageFilterGroup.addItem(                Terrasoft.createColumnFilterWithParameter(Terrasoft.ComparisonType.EQUAL,                    this.getDetailColumnPath("Stage.End"), true, Terrasoft.DataValueType.BOOLEAN));            filterGroup.addItem(endStageFilterGroup);        },        // Extending the FunnelBaseDataProvider base model method.         // Processes data for the stages in the pipeline.        getSeriesDataConfigByItem: function(responseItem) {            // Object that stores localizable strings.            var lcz = resources.localizableStrings;            // Receives a stage data object from the parent method.            var config = this.callParent(arguments);            // Receives data about the number of products in an opportunity from the sample result.            var products = responseItem.get("ProductsAmount");            products = Ext.isNumber(products) ? products : 0;            // Formats the strings.            var name = Ext.String.format("{0}<br/>{1}: {2}<br/>{3}: {4}",                config.menuHeaderValue, lcz.CntOpportunity, config.y, lcz.FunnelProductsCaption, products);            var displayValue = Ext.String.format("<br/>{0}: {1}", lcz.FunnelProductsCaption, products);            // Installs new data in the data object and returns it.             return Ext.apply(config, {                name: name,                displayValue: displayValue            });        }    });});