-- Stored procedure that uses exception handling and executes a custom scrip-- PostgreSQLDROP FUNCTION IF EXISTS public."tsp_CanConvertData" CASCADE;CREATE FUNCTION public."tsp_CanConvertData"(    EntitySchemaName NAME,    SourceColumnName NAME,    NewColumnDataType NAME,    CanConvert OUT BOOLEAN)AS $BODY$DECLARE    dataTypeName NAME;    newDataTypeName NAME;    newDataTypeSize INTEGER;    countRow INTEGER;    dataLength INTEGER;    convertDescription TEXT;    unicodeCharLength INTEGER = 2;    sqlQuery TEXT;    castQuery TEXT;BEGIN    CanConvert = FALSE;    dataTypeName = (        SELECT UPPER(data_type) FROM information_schema.columns        WHERE table_name = EntitySchemaName AND column_name = SourceColumnName);    IF dataTypeName IS NULL THEN        RETURN;    END IF;    SELECT "fn_ParseDataType".DataTypeName, "fn_ParseDataType".DataTypeSize    FROM public."fn_ParseDataType"(NewColumnDataType)    INTO newDataTypeName, newDataTypeSize;    DROP TABLE IF EXISTS "NotConvertTable";    CREATE TEMP TABLE "NotConvertTable" (        SourceDataType NAME,        DestinationDataType NAME    );    INSERT INTO "NotConvertTable" VALUES        ('INTEGER', 'UUID'),        ('INTEGER', 'TIMESTAMP WITHOUT TIME ZONE'),        ('INTEGER', 'DATE'),        ('INTEGER', 'TIME WITHOUT TIME ZONE'),        ('NUMERIC', 'UUID'),        ('NUMERIC', 'TIMESTAMP WITHOUT TIME ZONE'),        ('NUMERIC', 'DATE'),        ('NUMERIC', 'TIME WITHOUT TIME ZONE'),        ('BOOLEAN', 'UUID'),        ('BOOLEAN', 'TIMESTAMP WITHOUT TIME ZONE'),        ('BOOLEAN', 'DATE'),        ('BOOLEAN', 'TIME WITHOUT TIME ZONE'),        ('UUID', 'INTEGER'),        ('UUID', 'NUMERIC'),        ('UUID', 'BOOLEAN'),        ('UUID', 'TIMESTAMP WITHOUT TIME ZONE'),        ('UUID', 'DATE'),        ('UUID', 'TIME WITHOUT TIME ZONE'),        ('TIMESTAMP WITHOUT TIME ZONE', 'INTEGER'),        ('TIMESTAMP WITHOUT TIME ZONE', 'NUMERIC'),        ('TIMESTAMP WITHOUT TIME ZONE', 'BOOLEAN'),        ('TIMESTAMP WITHOUT TIME ZONE', 'UUID'),        ('DATE', 'INTEGER'),        ('DATE', 'NUMERIC'),        ('DATE', 'BOOLEAN'),        ('DATE', 'UUID'),        ('DATE', 'TIME WITHOUT TIME ZONE'),        ('TIME WITHOUT TIME ZONE', 'INTEGER'),        ('TIME WITHOUT TIME ZONE', 'NUMERIC'),        ('TIME WITHOUT TIME ZONE', 'BOOLEAN'),        ('TIME WITHOUT TIME ZONE', 'UUID'),        ('TIME WITHOUT TIME ZONE', 'DATE');    IF EXISTS(SELECT SourceDataType, DestinationDataType FROM "NotConvertTable"        WHERE SourceDataType = dataTypeName AND DestinationDataType = newDataTypeName) THEN        RETURN;    END IF;    DROP TABLE IF EXISTS ImplicitDataConvertTable;    CREATE TEMP TABLE ImplicitDataConvertTable (        SourceDataType NAME,        DestinationDataType NAME    );    INSERT INTO ImplicitDataConvertTable VALUES        ('INTEGER', 'INTEGER'),        ('INTEGER', 'NUMERIC'),        ('INTEGER', 'BOOLEAN'),        ('INTEGER', 'CHARACTER VARYING'),        ('INTEGER', 'TEXT'),        ('NUMERIC', 'CHARACTER VARYING'),        ('NUMERIC', 'TEXT'),        ('BOOLEAN', 'INTEGER'),        ('BOOLEAN', 'BOOLEAN'),        ('BOOLEAN', 'CHARACTER VARYING'),        ('BOOLEAN', 'TEXT'),        ('CHARACTER VARYING', 'TEXT'),        ('CHARACTER VARYING', 'BYTEA'),        ('TEXT', 'TEXT'),        ('TEXT', 'BYTEA'),        ('BYTEA', 'BYTEA'),        ('UUID', 'CHARACTER VARYING'),        ('UUID', 'TEXT'),        ('UUID', 'UUID'),        ('TIMESTAMP WITHOUT TIME ZONE', 'CHARACTER VARYING'),        ('TIMESTAMP WITHOUT TIME ZONE', 'TEXT'),        ('TIMESTAMP WITHOUT TIME ZONE', 'TIMESTAMP WITHOUT TIME ZONE'),        ('DATE', 'CHARACTER VARYING'),        ('DATE', 'TEXT'),        ('DATE', 'TIMESTAMP WITHOUT TIME ZONE'),        ('DATE', 'DATE'),        ('TIME WITHOUT TIME ZONE', 'CHARACTER VARYING'),        ('TIME WITHOUT TIME ZONE', 'TEXT'),        ('TIME WITHOUT TIME ZONE', 'TIMESTAMP WITHOUT TIME ZONE'),        ('TIME WITHOUT TIME ZONE', 'TIME WITHOUT TIME ZONE'),        ('TIMESTAMP WITHOUT TIME ZONE', 'DATE'),        ('TIMESTAMP WITHOUT TIME ZONE', 'TIME WITHOUT TIME ZONE'),        ('INTEGER', 'BYTEA'),        ('NUMERIC', 'BOOLEAN'),        ('NUMERIC', 'BYTEA'),        ('BOOLEAN', 'NUMERIC'),        ('BOOLEAN', 'BYTEA'),        ('UUID', 'BYTEA'),        ('TIMESTAMP WITHOUT TIME ZONE', 'BYTEA'),        ('DATE', 'BYTEA'),        ('TIME WITHOUT TIME ZONE', 'BYTEA'),        ('NUMERIC', 'INTEGER'),        ('NUMERIC', 'NUMERIC');    IF EXISTS(SELECT SourceDataType, DestinationDataType FROM ImplicitDataConvertTable        WHERE SourceDataType = dataTypeName AND DestinationDataType = newDataTypeName) THEN        CanConvert = TRUE;        RETURN;    END IF;    EXECUTE FORMAT('SELECT count(*) FROM %1$I', EntitySchemaName) INTO countRow;    CanConvert = (countRow = 0);    IF CanConvert THEN        RETURN;    END IF;    DROP TABLE IF EXISTS "ExplicitDataConvertTable";    CREATE TEMP TABLE "ExplicitDataConvertTable" (        SourceDataType NAME,        DestinationDataType NAME    );    INSERT INTO "ExplicitDataConvertTable" VALUES        ('CHARACTER VARYING', 'INTEGER'),        ('CHARACTER VARYING', 'NUMERIC'),        ('CHARACTER VARYING', 'BOOLEAN'),        ('CHARACTER VARYING', 'UUID'),        ('CHARACTER VARYING', 'TIMESTAMP WITHOUT TIME ZONE'),        ('CHARACTER VARYING', 'DATE'),        ('CHARACTER VARYING', 'TIME WITHOUT TIME ZONE'),        ('TEXT', 'INTEGER'),        ('TEXT', 'NUMERIC'),        ('TEXT', 'BOOLEAN'),        ('TEXT', 'UUID'),        ('TEXT', 'TIMESTAMP WITHOUT TIME ZONE'),        ('TEXT', 'DATE'),        ('TEXT', 'TIME WITHOUT TIME ZONE'),        ('BYTEA', 'INTEGER'),        ('BYTEA', 'NUMERIC'),        ('BYTEA', 'BOOLEAN'),        ('BYTEA', 'UUID'),        ('BYTEA', 'TIMESTAMP WITHOUT TIME ZONE'),        ('BYTEA', 'DATE'),        ('BYTEA', 'TEXT'),        ('BYTEA', 'TIME WITHOUT TIME ZONE'),        ('NUMERIC', 'BOOLEAN');    IF EXISTS(SELECT SourceDataType, DestinationDataType FROM "ExplicitDataConvertTable"        WHERE SourceDataType = dataTypeName AND DestinationDataType = newDataTypeName) THEN        castQuery = FORMAT('CAST(%1$I%3$s AS %2$s)', SourceColumnName, NewColumnDataType,            CASE                WHEN dataTypeName = 'BYTEA' THEN '::TEXT'                WHEN dataTypeName = 'NUMERIC' THEN '::INTEGER'                ELSE ''            END);        sqlQuery = FORMAT('SELECT COUNT(*) FROM %1$I WHERE %2$s = %2$s',            EntitySchemaName, castQuery);        BEGIN            EXECUTE sqlQuery;            CanConvert = TRUE;        EXCEPTION WHEN OTHERS THEN            CanConvert = FALSE;        END;        RETURN;    END IF;    DROP TABLE IF EXISTS "ImplicitDataOverflowConvertTable";    CREATE TEMP TABLE "ImplicitDataOverflowConvertTable" (        SourceDataType NAME,        DestinationDataType NAME    );    INSERT INTO "ImplicitDataOverflowConvertTable" VALUES        ('CHARACTER VARYING', 'CHARACTER VARYING'),        ('TEXT', 'CHARACTER VARYING'),        ('BYTEA', 'CHARACTER VARYING');    IF EXISTS(SELECT SourceDataType, DestinationDataType FROM "ImplicitDataOverflowConvertTable"        WHERE SourceDataType = dataTypeName AND DestinationDataType = newDataTypeName) THEN        EXECUTE FORMAT('SELECT count(*) FROM %1$I', EntitySchemaName) INTO countRow;        CanConvert = (countRow = 0);        IF CanConvert THEN            RETURN;        END IF;        BEGIN            EXECUTE FORMAT('SELECT MAX(PG_COLUMN_SIZE(%1$I)) FROM %2$I', SourceColumnName, EntitySchemaName)            INTO dataLength;            IF (dataLength <= newDataTypeSize) THEN                CanConvert = TRUE;            ELSE                CanConvert = FALSE;            END IF;        EXCEPTION WHEN OTHERS THEN            CanConvert = FALSE;        END;    END IF;END;$BODY$LANGUAGE 'plpgsql';