-- Stored procedure that uses exception handling and executes a custom script-- MSSQLIF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tsp_CanConvertData]') AND type IN (N'P', N'PC'))DROP PROCEDURE [dbo].[tsp_CanConvertData]GOCREATE PROCEDURE [dbo].[tsp_CanConvertData]    @EntitySchemaName SYSNAME,    @SourceColumnName SYSNAME,    @NewColumnDataType SYSNAME,    @Result BIT OUTASBEGIN    SET NOCOUNT ON    SET @Result = 0    DECLARE @sql NVARCHAR(MAX)    DECLARE @unicodeCharLength INT = 2    DECLARE @dataTypeName SYSNAME    DECLARE @dataTypeSize INT    DECLARE @dataTypePrecision INT    SELECT        @dataTypeName = UPPER(DATA_TYPE),        @dataTypeSize =        CASE            WHEN CHARACTER_MAXIMUM_LENGTH IS NULL THEN NUMERIC_PRECISION            ELSE CHARACTER_MAXIMUM_LENGTH        END,        @dataTypePrecision = ISNULL(NUMERIC_SCALE, 0)    FROM INFORMATION_SCHEMA.COLUMNS    WHERE TABLE_NAME = @EntitySchemaName    AND COLUMN_NAME = @SourceColumnName    IF (@dataTypeName IS NULL)    BEGIN        RETURN    END    DECLARE @newDataTypeName SYSNAME    DECLARE @newDataTypeSize INT    DECLARE @newDataTypePrecision INT    DEClARE @i INT    DECLARE @newDataTypeSizeDefinition NVARCHAR(MAX)    SET @i = CHARINDEX('(', @NewColumnDataType)    IF (@i = 0)    BEGIN        SET @newDataTypeName = @NewColumnDataType        SET @newDataTypeSize = 0        SET @newDataTypePrecision = 0    END ELSE    BEGIN        SET @newDataTypeName = UPPER(LTRIM(RTRIM(SUBSTRING(@NewColumnDataType, 1, @i - 1))))        SET @newDataTypeSizeDefinition = LTRIM(RTRIM(SUBSTRING(@NewColumnDataType, @i + 1,            LEN(@NewColumnDataType))))        SET @i = CHARINDEX(')', @newDataTypeSizeDefinition)        IF (@i > 0)        BEGIN            SET @newDataTypeSizeDefinition = LTRIM(RTRIM(SUBSTRING(@newDataTypeSizeDefinition, 1, @i - 1)))        END        SET @i = CHARINDEX(',', @newDataTypeSizeDefinition)        IF (@i > 0)        BEGIN            SET @newDataTypeSize = CAST(LTRIM(RTRIM(SUBSTRING(@newDataTypeSizeDefinition, 1, @i - 1))) AS INT)            SET @newDataTypePrecision = CAST(LTRIM(RTRIM(SUBSTRING(@newDataTypeSizeDefinition, @i + 1,                LEN(@newDataTypeSizeDefinition)))) AS INT)        END ELSE        BEGIN            SET @newDataTypePrecision = 0            IF (UPPER(@newDataTypeSizeDefinition) = 'MAX')            BEGIN                SET @newDataTypeSize = -1            END ELSE            BEGIN                SET @newDataTypeSize = CAST(@newDataTypeSizeDefinition AS INT)            END        END    END    DECLARE @ImplicitDataConvertTable TABLE (        SourceDataType SYSNAME,        DestinationDataType SYSNAME    )    INSERT INTO @ImplicitDataConvertTable    SELECT 'INT', 'INT'    UNION ALL    SELECT 'INT', 'BIT'    UNION ALL    SELECT 'INT', 'DECIMAL'    UNION ALL    SELECT 'INT', 'VARCHAR'    UNION ALL    SELECT 'INT', 'NVARCHAR'    UNION ALL    SELECT 'INT', 'VARBINARY'    UNION ALL    SELECT 'BIT', 'BIT'    UNION ALL    SELECT 'BIT', 'INT'    UNION ALL    SELECT 'BIT', 'DECIMAL'    UNION ALL    SELECT 'BIT', 'VARCHAR'    UNION ALL    SELECT 'BIT', 'NVARCHAR'    UNION ALL    SELECT 'BIT', 'VARBINARY'    UNION ALL    SELECT 'DECIMAL', 'BIT'    UNION ALL    SELECT 'UNIQUEIDENTIFIER', 'UNIQUEIDENTIFIER'    UNION ALL    SELECT 'UNIQUEIDENTIFIER', 'VARBINARY'    UNION ALL    SELECT 'VARCHAR', 'INT'    UNION ALL    SELECT 'VARCHAR', 'BIT'    UNION ALL    SELECT 'VARCHAR', 'UNIQUEIDENTIFIER'    UNION ALL    SELECT 'DATETIME2', 'DATETIME2'    UNION ALL    SELECT 'DATETIME2', 'DATE'    UNION ALL    SELECT 'DATETIME2', 'TIME'    UNION ALL    SELECT 'DATETIME2', 'VARCHAR'    UNION ALL    SELECT 'DATE', 'DATE'    UNION ALL    SELECT 'DATE', 'DATETIME2'    UNION ALL    SELECT 'DATE', 'VARCHAR'    UNION ALL    SELECT 'DATE', 'NVARCHAR'    UNION ALL    SELECT 'TIME', 'TIME'    UNION ALL    SELECT 'TIME', 'DATETIME2'    UNION ALL    SELECT 'TIME', 'VARCHAR'    UNION ALL    SELECT 'TIME', 'NVARCHAR'    UNION ALL    SELECT 'VARBINARY', 'INT'    UNION ALL    SELECT 'VARBINARY', 'BIT'    UNION ALL    SELECT 'VARBINARY', 'UNIQUEIDENTIFIER'    IF EXISTS(SELECT * FROM @ImplicitDataConvertTable        WHERE SourceDataType = @dataTypeName AND DestinationDataType = @newDataTypeName)    BEGIN        SET @Result = 1        RETURN    END    DECLARE @ImplicitDataOverflowConvertTable TABLE (        SourceDataType SYSNAME,        DestinationDataType SYSNAME    )    INSERT INTO @ImplicitDataOverflowConvertTable    SELECT 'DECIMAL', 'INT'    UNION ALL    SELECT 'DECIMAL', 'DECIMAL'    UNION ALL    SELECT 'DECIMAL', 'VARCHAR'    UNION ALL    SELECT 'DECIMAL', 'NVARCHAR'    UNION ALL    SELECT 'DECIMAL', 'VARBINARY'    UNION ALL    SELECT 'UNIQUEIDENTIFIER', 'VARCHAR'    UNION ALL    SELECT 'UNIQUEIDENTIFIER', 'NVARCHAR'    UNION ALL    SELECT 'VARCHAR', 'INT'    UNION ALL    SELECT 'VARCHAR', 'BIT'    UNION ALL    SELECT 'VARCHAR', 'DECIMAL'    UNION ALL    SELECT 'VARCHAR', 'VARCHAR'    UNION ALL    SELECT 'VARCHAR', 'NVARCHAR'    UNION ALL    SELECT 'NVARCHAR', 'INT'    UNION ALL    SELECT 'NVARCHAR', 'BIT'    UNION ALL    SELECT 'NVARCHAR', 'DECIMAL'    UNION ALL    SELECT 'NVARCHAR', 'VARCHAR'    UNION ALL    SELECT 'NVARCHAR', 'NVARCHAR'    UNION ALL    SELECT 'VARBINARY', 'VARCHAR'    UNION ALL    SELECT 'VARBINARY', 'NVARCHAR'    UNION ALL    SELECT 'VARBINARY', 'VARBINARY'    IF EXISTS(SELECT * FROM @ImplicitDataOverflowConvertTable        WHERE SourceDataType = @dataTypeName AND DestinationDataType = @newDataTypeName)    BEGIN        SET @sql = N'IF EXISTS(SELECT * FROM [' + @EntitySchemaName + ']) SET @Result = 0 ELSE SET @Result = 1'        EXEC sp_executesql @sql, N'@Result BIT OUT', @Result = @Result OUT        IF (@Result = 1)        BEGIN            RETURN        END        BEGIN TRY            IF (@dataTypeName = 'DECIMAL' AND @newDataTypeName = 'INT') OR                (@dataTypeName = 'DECIMAL' AND @newDataTypeName = 'VARCHAR') OR                (@dataTypeName = 'DECIMAL' AND @newDataTypeName = 'NVARCHAR') OR                (@dataTypeName = 'DECIMAL' AND @newDataTypeName = 'VARBINARY') OR                (@dataTypeName = 'DECIMAL' AND @newDataTypeName = 'DECIMAL')            BEGIN                DECLARE @cnt INT                DECLARE @ConvertDescription NVARCHAR(MAX)                SET @ConvertDescription = 'CONVERT(' + @NewColumnDataType +', [' + @SourceColumnName+ '])'                SET @sql = N'IF EXISTS(SELECT * FROM [' + @EntitySchemaName +\*'] WHERE ' +                @ConvertDescription + ' = ' + @ConvertDescription + ') SET @cnt = 1 ELSE SET @cnt = 0'                EXEC sp_executesql @sql, N'@cnt INT OUT', @cnt = @cnt OUT                SET @Result = 1            END ELSE            BEGIN                DECLARE @dl INT                SET @sql = N'SELECT @dl = MAX(DATALENGTH([' + @SourceColumnName + '])) ' +                'FROM [' + @EntitySchemaName + ']'                EXEC sp_executesql @sql, N'@dl INT OUT', @dl = @dl OUT                IF (@newDataTypeName IN ('VARCHAR', 'NVARCHAR', 'VARBINARY') AND @newDataTypeSize = -1)                BEGIN                    SET @Result = 1                END ELSE                IF (@dl <= @newDataTypeSize OR (                    @newDataTypeName IN ('NVARCHAR', 'NCHAR') AND (@dl / @unicodeCharLength) <= @newDataTypeSize))                BEGIN                    SET @Result = 1                END ELSE                BEGIN                    SET @Result = 0                END            END        END TRY        BEGIN CATCH            SET @Result = 0        END CATCH    END ELSE    BEGIN        SET @Result = 0    ENDENDGO