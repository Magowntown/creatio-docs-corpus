-- Stored procedure that uses loops, cursors, and temporary tables-- Microsoft SQLIF NOT OBJECT_ID('[dbo].[tsp_ActualizeUserRoles]') IS NULLBEGIN    DROP PROCEDURE [dbo].[tsp_ActualizeUserRoles]ENDGOCREATE PROCEDURE dbo.tsp_ActualizeUserRoles (@UserId uniqueidentifier)ASBEGIN    SET NOCOUNT ON    IF OBJECT_ID('tempdb..#AdminUnitListTemp') IS NOT NULL    BEGIN        DROP TABLE [#AdminUnitListTemp];    END;    CREATE TABLE [#AdminUnitListTemp] (        [UserId] uniqueidentifier NOT NULL,        [Id] uniqueidentifier NOT NULL,        [Name] NVARCHAR(250) NOT NULL,        [ParentRoleId] uniqueidentifier NULL,        [Granted] BIT NULL    );    DECLARE @GetAdminUnitList TABLE (        [Id] uniqueidentifier NOT NULL,        [Name] nvarchar(260) NOT NULL,        [ParentRoleId] uniqueidentifier NULL    );    DECLARE @NewRoles TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @OldUserRoles TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @getUserAdminUnits CURSOR;    DECLARE @SysAdminUnitRoles TABLE (        [Id] uniqueidentifier,        [Name] nvarchar(260),        [ParentRoleId] uniqueidentifier    );    DECLARE @ManagersBeforeActualization TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @ManagersAfterActualization TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @StillManagers TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @NoLongerManagers TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @NewManagers TABLE ([Id] uniqueidentifier NOT NULL);    DECLARE @SysAdminUnitId uniqueidentifier;    -- Old user roles    INSERT INTO @OldUserRoles        SELECT DISTINCT [SysAdminUnitInRole].[SysAdminUnitRoleId] [Id]        FROM [SysAdminUnitInRole]        WHERE [SysAdminUnitInRole].[SysAdminUnitId] = @UserId    -- Old user managers    INSERT INTO @ManagersBeforeActualization        SELECT DISTINCT [SysUserInRole].[SysUserId] [Id]        FROM [SysAdminUnitInRole]        INNER JOIN [SysAdminUnit] [Roles]            ON [SysAdminUnitInRole].[SysAdminUnitRoleId] = [Roles].[Id]        INNER JOIN @OldUserRoles            ON [Roles].[ParentRoleId] = [@OldUserRoles].[Id]        INNER JOIN [SysUserInRole]            ON [SysUserInRole].[SysRoleId] = [Roles].[Id]        WHERE [Roles].[SysAdminUnitTypeValue] = 2    -- Get and insert new user roles    INSERT INTO @GetAdminUnitList EXEC [tsp_GetAdminUnitList] @UserId=@UserId;    INSERT INTO @NewRoles SELECT [Id] FROM @GetAdminUnitList;    DELETE FROM [SysAdminUnitInRole] WHERE [SysAdminUnitId] = @UserId;    INSERT INTO [SysAdminUnitInRole] ([SysAdminUnitId], [SysAdminUnitRoleId])        SELECT DISTINCT @UserId, [Id] FROM @NewRoles;    -- User managers after actualization    INSERT INTO @ManagersAfterActualization        SELECT DISTINCT            [SysUserInRole].[SysUserId] [Id]        FROM [SysAdminUnitInRole]        INNER JOIN [SysAdminUnit] [Roles]            ON [SysAdminUnitInRole].[SysAdminUnitRoleId] = [Roles].[Id]        INNER JOIN @NewRoles NewRoles            ON [Roles].[ParentRoleId] = NewRoles.[Id]        INNER JOIN [SysUserInRole]            ON [SysUserInRole].[SysRoleId] = [Roles].[Id]        WHERE [Roles].[SysAdminUnitTypeValue] = 2;    -- New (who were not but become) user managers    INSERT INTO @NewManagers        SELECT [Id] FROM @ManagersAfterActualization AS managersAfterActualization            WHERE NOT EXISTS (                SELECT NULL                FROM @ManagersBeforeActualization AS managersBeforeActualization                WHERE managersBeforeActualization.[Id] = managersAfterActualization.[Id]            );    -- Add all user roles to new managers and their grantee-users, if they arent already have    SET @getUserAdminUnits = CURSOR FOR        SELECT DISTINCT [Id] FROM (            SELECT [Id] FROM @NewManagers            UNION            SELECT [GranteeSysAdminUnitId]            FROM [SysAdminUnitGrantedRight]            WHERE EXISTS (                SELECT NULL FROM @NewManagers as newManagers                WHERE [SysAdminUnitGrantedRight].[GrantorSysAdminUnitId] = newManagers.[Id]            )        ) Roles;    OPEN @getUserAdminUnits;    FETCH NEXT    FROM @getUserAdminUnits INTO @SysAdminUnitId;    WHILE @@FETCH_STATUS = 0    BEGIN        INSERT INTO [SysAdminUnitInRole] ([SysAdminUnitId], [SysAdminUnitRoleId])            SELECT DISTINCT @SysAdminUnitId, [Id]            FROM @NewRoles AS newRoles            WHERE NOT EXISTS (                SELECT 1                FROM [SysAdminUnitInRole]                WHERE [SysAdminUnitInRole].[SysAdminUnitId] = @SysAdminUnitId                AND [SysAdminUnitInRole].[SysAdminUnitRoleId] = newRoles.[Id]            );        FETCH NEXT FROM @getUserAdminUnits INTO @SysAdminUnitId;    END;    CLOSE @getUserAdminUnits;    DEALLOCATE @getUserAdminUnits;    DECLARE @isUserLostAtLeastOneRole INT = (        SELECT COUNT(*)        FROM @OldUserRoles AS oldUserRoles        WHERE NOT EXISTS (            SELECT 1            FROM @NewRoles AS newUserRoles            WHERE newUserRoles.[Id] = oldUserRoles.[Id]        )    );    -- Still (who were and remained) user managers    INSERT INTO @StillManagers        SELECT  DISTINCT managersAfterActualization.[Id] AS [Id]        FROM @ManagersAfterActualization AS managersAfterActualization            JOIN @ManagersBeforeActualization AS managersBeforeActualization                ON managersAfterActualization.[Id] = managersBeforeActualization.[Id];    -- If user lost at least one role, we need to actualize all his still-managers.    -- If not (user only gained new roles) - we just add to still-managers and their grantee-users new user roles.    IF (@isUserLostAtLeastOneRole = 0)    BEGIN        -- Add all new user roles to his still-managers and to their grantee-users        SET @getUserAdminUnits = CURSOR FOR            SELECT DISTINCT [Id] FROM (                SELECT stillManagers.[Id] AS [Id]                FROM @StillManagers AS stillManagers                UNION                SELECT [GranteeSysAdminUnitId]                FROM [SysAdminUnitGrantedRight]                WHERE EXISTS (                    SELECT NULL                    FROM @StillManagers AS stillManagers                    WHERE stillManagers.[Id] = [GrantorSysAdminUnitId]                )            ) Roles;        OPEN @getUserAdminUnits;        FETCH NEXT        FROM @getUserAdminUnits INTO @SysAdminUnitId;        WHILE @@FETCH_STATUS = 0        BEGIN            INSERT INTO [SysAdminUnitInRole] ([SysAdminUnitId], [SysAdminUnitRoleId])                SELECT DISTINCT @SysAdminUnitId, [Id]                FROM @NewRoles AS newRoles                WHERE NOT EXISTS (                    SELECT 1                    FROM [SysAdminUnitInRole]                    WHERE [SysAdminUnitInRole].[SysAdminUnitId] = @SysAdminUnitId                        AND [SysAdminUnitInRole].[SysAdminUnitRoleId] = newRoles.[Id]                );            FETCH NEXT FROM @getUserAdminUnits INTO @SysAdminUnitId;        END;        CLOSE @getUserAdminUnits;        DEALLOCATE @getUserAdminUnits;    END ELSE    BEGIN        --Actualize all roles for still-managers        SET @getUserAdminUnits = CURSOR FOR            SELECT DISTINCT [Id]            FROM @StillManagers            UNION                SELECT [GranteeSysAdminUnitId]                FROM [SysAdminUnitGrantedRight]                WHERE EXISTS (                SELECT NULL                FROM @StillManagers AS stillManagers                WHERE stillManagers.[Id] = [GrantorSysAdminUnitId]                );        OPEN @getUserAdminUnits;        FETCH NEXT        FROM @getUserAdminUnits INTO @SysAdminUnitId;        WHILE @@FETCH_STATUS = 0        BEGIN            DELETE FROM @SysAdminUnitRoles;            INSERT INTO @SysAdminUnitRoles                EXEC [tsp_GetAdminUnitList] @UserId=@SysAdminUnitId;            BEGIN TRAN;                DELETE FROM [dbo].[SysAdminUnitInRole] WHERE SysAdminUnitId = @SysAdminUnitId;                INSERT INTO [dbo].[SysAdminUnitInRole] (SysAdminUnitId, SysAdminUnitRoleId)                    SELECT @SysAdminUnitId, [Id] FROM @SysAdminUnitRoles;            COMMIT;            FETCH NEXT                FROM @getUserAdminUnits INTO @SysAdminUnitId;        END;        CLOSE @getUserAdminUnits;        DEALLOCATE @getUserAdminUnits;    END;    -- No longer (who were but not remained) user managers    INSERT INTO @NoLongerManagers        SELECT [Id] FROM @ManagersBeforeActualization as managersBeforeActualization            WHERE NOT EXISTS (                SELECT NULL                FROM @ManagersAfterActualization AS managersAfterActualization                WHERE managersAfterActualization.[Id] = managersBeforeActualization.[Id]            );    -- Actualize roles for all noLonger-managers, his grantee-users and all grantee-users of user    SET @getUserAdminUnits = CURSOR FOR        SELECT DISTINCT [Id] FROM (            SELECT [Id] FROM @NoLongerManagers            UNION            SELECT [GranteeSysAdminUnitId]            FROM [SysAdminUnitGrantedRight]            WHERE EXISTS (                SELECT NULL                FROM @NoLongerManagers AS noLongerManagers                WHERE noLongerManagers.[Id] = [GrantorSysAdminUnitId]            )            UNION ALL            SELECT GranteeSysAdminUnitId            FROM SysAdminUnitGrantedRight            WHERE GrantorSysAdminUnitId = @UserId        ) Roles;    OPEN @getUserAdminUnits;    FETCH NEXT        FROM @getUserAdminUnits INTO @SysAdminUnitId;    WHILE @@FETCH_STATUS = 0    BEGIN        DELETE FROM @SysAdminUnitRoles;        INSERT INTO @SysAdminUnitRoles            EXEC [tsp_GetAdminUnitList] @UserId=@SysAdminUnitId;        BEGIN TRAN;            DELETE FROM [dbo].[SysAdminUnitInRole] WHERE SysAdminUnitId = @SysAdminUnitId;            INSERT INTO [dbo].[SysAdminUnitInRole] (SysAdminUnitId, SysAdminUnitRoleId)                SELECT @SysAdminUnitId, [Id] FROM @SysAdminUnitRoles;        COMMIT;        FETCH NEXT            FROM @getUserAdminUnits INTO @SysAdminUnitId;    END;    CLOSE @getUserAdminUnits;    DEALLOCATE @getUserAdminUnits;    IF OBJECT_ID('tempdb..#AdminUnitListTemp') IS NOT NULL    BEGIN        DROP TABLE [#AdminUnitListTemp];    END;END;GO