namespace Terrasoft.Configuration{    using System;    using System.Collections.Generic;    using System.Collections.ObjectModel;    using System.Globalization;    using System.Linq;    using Newtonsoft.Json;    using Terrasoft.Common;    using Terrasoft.Core;    using Terrasoft.Core.Campaign;    using Terrasoft.Core.DB;    using Terrasoft.Core.Process;        [DesignModeProperty(        Name = "SmsResponseId",        UsageType = DesignModeUsageType.NotVisible,        MetaPropertyName = SmsResponseIdPropertyName)]    [DesignModeProperty(        Name = "IsResponseBasedStart",        UsageType = DesignModeUsageType.Advanced,        MetaPropertyName = IsResponseBasedStartPropertyName)]        public class UsrSmsConditionalTransitionElement        : ConditionalSequenceFlowElement    {        /* Constants for property names used in metadata serialization. */        private const string SmsResponseIdPropertyName = "SmsResponseId";        private const string IsResponseBasedStartPropertyName = "IsResponseBasedStart";        /* Default constructor. */        public UsrSmsConditionalTransitionElement() {}        /* Copy constructor without rebind and schema. */        public UsrSmsConditionalTransitionElement(            UsrSmsConditionalTransitionElement source)            : this(source, null, null)         {}        /* Copy constructors for cloning the element in schema operations. */        public UsrSmsConditionalTransitionElement(            UsrSmsConditionalTransitionElement source,            Dictionary<Guid, Guid> dictToRebind,            Core.Campaign.CampaignSchema parentSchema)            : base(source, dictToRebind, parentSchema) {                IsResponseBasedStart = source.IsResponseBasedStart;                _smsResponseIdJson = JsonConvert.SerializeObject(                    source.SmsResponseId                );        }        /* Store "SmsResponseId" in serialized JSON format. */        private string _smsResponseIdJson;        /* Internal helper property, return the collection of response IDs. */        private IEnumerable<Guid> Responses {            get {                return SmsResponseId;            }        }        /* Meta property that stores a collection of SMS response IDs. */        [MetaTypeProperty("{DC597899-B831-458A-A58E-FB43B1E266AC}")]        public IEnumerable<Guid> SmsResponseId {            get {                return !string.IsNullOrWhiteSpace(_smsResponseIdJson)                    ? JsonConvert.DeserializeObject<IEnumerable<Guid>>(_smsResponseIdJson)                    : Enumerable.Empty<Guid>();            }        }        /* Meta property that defines if the transition starts based on a        response. */        [MetaTypeProperty("{3FFA4EA0-62CC-49A8-91FF-4096AEC561F6}",        IsExtraProperty = true, IsUserProperty = true)]        public virtual bool IsResponseBasedStart {            get;            set;        }        /* Read element metadata from the schema definition during        deserialization. */        protected override void ApplyMetaDataValue(DataReader reader) {            base.ApplyMetaDataValue(reader);            switch (reader.CurrentName) {                case SmsResponseIdPropertyName:                    _smsResponseIdJson = reader.GetValue<string>();                    break;                case IsResponseBasedStartPropertyName:                    IsResponseBasedStart = reader.GetBoolValue();                    break;                default:                    break;            }        }        /* Write element metadata to the schema definition during serialization. */        public override void WriteMetaData(DataWriter writer) {            base.WriteMetaData(writer);            writer.WriteValue(                IsResponseBasedStartPropertyName,                IsResponseBasedStart,                false            );            writer.WriteValue(                SmsResponseIdPropertyName,                _smsResponseIdJson,                null            );        }        /* Create a clone of the schema element. */        public override object Clone() {            return new UsrSmsConditionalTransitionElement(this);        }        /* Create a copy of the element using rebind support for schema references. */        public override object Copy(            Dictionary<Guid, Guid> dictToRebind,            Core.Campaign.CampaignSchema parentSchema        ) {            return new UsrSmsConditionalTransitionElement(                this,                dictToRebind,                parentSchema            );        }        /* Create the runtime process flow element that will be executed in        the campaign. Pass metadata values to the executable process element. */        public override ProcessFlowElement CreateProcessFlowElement(            UserConnection userConnection        ) {            var sourceElement = SourceRef as UsrSmsElement;            var executableElement = new UsrSmsConditionalTransitionFlowElement {                UserConnection = userConnection,                SmsResponses = SmsResponseId,                PhoneNumber = sourceElement.PhoneNumber,                SmsText = sourceElement.SmsText            };            InitializeCampaignProcessFlowElement(executableElement);            InitializeCampaignTransitionFlowElement(executableElement);            InitializeConditionalTransitionFlowElement(executableElement);            return executableElement;        }    }}