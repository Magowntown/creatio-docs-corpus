namespace Terrasoft.Configuration{    using System;    using System.CodeDom.Compiler;    using System.Collections.Generic;    using System.Data;    using System.Linq;    using System.Runtime.Serialization;    using System.ServiceModel;    using System.ServiceModel.Web;    using System.ServiceModel.Activation;    using System.Text;    using System.Text.RegularExpressions;    using System.Web;    using Terrasoft.Common;    using Terrasoft.Core;    using Terrasoft.Core.DB;    using Terrasoft.Core.Entities;    using Terrasoft.Core.Packages;    using Terrasoft.Core.Factories;    /* Attribute that stores the macro name. */    [ExpressionConverterAttribute("AccountInfoByAccountType")]    /* Class that implements the "IExpressionConverter" interface. */    class UsrAccountInfoByAccountType : IExpressionConverter    {        private UserConnection _userConnection;        private string _customerAdditional;        private string _partnerAdditional;        /* Call localizable string values. */        private void SetResources() {            string sourceCodeName = "UsrAccountInfoByAccountType";            _customerAdditional = new LocalizableString(_userConnection.ResourceStorage, sourceCodeName, "LocalizableStrings.CustomerAccountType.Value");            _partnerAdditional =  new LocalizableString(_userConnection.ResourceStorage, sourceCodeName, "LocalizableStrings.PartnerAccountType.Value");        }        /* Implement the "Evaluate()" method of the "IExpressionConverter" interface. */        public string Evaluate(object value, string arguments = "")        {            try            {                _userConnection = (UserConnection)HttpContext.Current.Session["UserConnection"];                Guid accountId = new Guid(value.ToString());                return getAccountInfo(accountId);            }            catch (Exception err)            {                return err.Message;            }        }        /* Receive additional information based on the account type ID. */        private string getAccountInfo(Guid accountId)        {            SetResources();            try            {                /* Create an "EntitySchemaQuery" instance that has the "Account" root schema. */                EntitySchemaQuery esq = new EntitySchemaQuery(_userConnection.EntitySchemaManager, "Account");                /* Add columns to the query. */                var columnType = esq.AddColumn("Type.Name").Name;                var columnNumber = esq.AddColumn("EmployeesNumber.Name").Name;                var columnRevenue = esq.AddColumn("AnnualRevenue.Name").Name;                /* Filter records by the account ID. */                var accountFilter = esq.CreateFilterWithParameters(                    FilterComparisonType.Equal,                    "Id",                    accountId                );                esq.Filters.Add(accountFilter);                /* Retrieve a record collection. */                EntityCollection entities = esq.GetEntityCollection(_userConnection);                /* If the collection includes records, the method returns data depending on the account type. */                if (entities.Count > 0)                {                    Entity entity = entities[0];                    var type = entity.GetTypedColumnValue<string>(columnType);                    switch (type)                    {                        case "Customer":                            return String.Format(_customerAdditional, entity.GetTypedColumnValue<string>(columnRevenue));                        case "Partner":                            return String.Format(_partnerAdditional, entity.GetTypedColumnValue<string>(columnNumber));                        default:                            return String.Empty;                    }                }                return String.Empty;            }            catch (Exception err)            {                throw err;            }        }    }}