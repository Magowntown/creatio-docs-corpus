namespace Terrasoft.Configuration.Omnichannel.Messaging{    using System;    using System.ServiceModel;    using System.ServiceModel.Activation;    using System.ServiceModel.Web;    using Terrasoft.Common;    using Terrasoft.Core;    using Terrasoft.Core.DB;    using Terrasoft.Web.Common.ServiceRouting;    #region Class: SomeProviderOmnichannelMessagingService    [ServiceContract]    [AspNetCompatibilityRequirements(RequirementsMode = AspNetCompatibilityRequirementsMode.Required)]    [DefaultServiceRoute]    public class SomeProviderOmnichannelMessagingService : OmnichannelMessagingService    {        #region Constructors: Public        public SomeProviderIncomingMessage() : base()        { }        /* Initialize a new "SomeProviderIncomingMessage" class instance. */        public SomeProviderIncomingMessage(UserConnection userConnection) : base(userConnection)        { }        #endregion        #region Methods: Private        private void GetChannelAndQueueBySource(MessagingMessage message) {            Select channelSelect = new Select(UserConnection)                .Top(1).Column("Id")                .Column("ChatQueueId")                .From("Channel")                .Where("Source").IsEqual(Column.Parameter(message.Recipient))                .And("IsActive").IsEqual(Column.Parameter(true)) as Select;                           channelSelect.ExecuteReader(reader => {                message.ChannelId = reader.GetColumnValue("Id").ToString();                message.ChannelQueueId = reader.GetColumnValue("ChatQueueId");            });        }        #endregion        #region Methods: Public        /* The method that receives messages from the integration API. */        [OperationContract]        [WebInvoke(UriTemplate = "receive", Method = "POST", RequestFormat = WebMessageFormat.Json, BodyStyle = WebMessageBodyStyle.Bare, ResponseFormat = WebMessageFormat.Json)]        public void ReceiveMessage(SomeProviderIncomingMessage message) {            /* Convert the message. */            MessagingMessage messagingMessage = new MessagingMessage(SomeProviderIncomingMessageConverter.Convert(message));            /* Identify the channel using the "Source" database field. */            GetChannelAndQueueBySource(messagingMessage);            /* If an open chat with this user is not found, create a new chat. Otherwise, add a message to an existing chat. If the user contacts you for the first time, create a contact and fill out their credentials. Otherwise, bind the chat to an existing contact. */            InternalReceive(messagingMessage);        }        #endregion    }    #endregion}