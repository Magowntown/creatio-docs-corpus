/* Define the schema and set its dependencies on other modules. */define("UsrCourierCertDetail", ["ConfigurationEnums"], function(configurationEnums) {    return {        /* The name of the detail object schema. */        entitySchemaName: "UsrCourierCertInOrder",        /* The methods of the detail schema. */        methods: {            /* Return the columns the query selects. */            getGridDataColumns: function() {                return {                    "Id": {path: "Id"},                    "Document": {path: "UsrDocument"},                    "Document.Number": {path: "UsrDocument.Number"}                };            },            /* Configure and display the lookup pop-up box. */            openDocumentLookup: function() {                /* The configuration object. */                var config = {                    /* The schema name for the object whose records to display on the lookup. */                    entitySchemaName: "Document",                    /* The flag that enables multiple selection. */                    multiSelect: true,                    /* Columns to use in the lookup. For example, for sorting. */                    columns: ["Number", "Date", "Type"]                };                var OrderId = this.get("MasterRecordId");                if (this.Ext.isEmpty(OrderId)) {                    return;                }                /* The EntitySchemaQuery class instance. */                var esq = this.Ext.create("Terrasoft.EntitySchemaQuery", {                    /* Set the root schema. */                    rootSchemaName: this.entitySchemaName                });                /* Add the Id column. */                esq.addColumn("Id");                /* Add the Id column from the Document schema. */                esq.addColumn("Document.Id", "DocumentId");                /* Create filters and add them to the query collection. */                esq.filters.add("filterOrder", this.Terrasoft.createColumnFilterWithParameter(                    this.Terrasoft.ComparisonType.EQUAL, "UsrOrder", OrderId));                /* Retrieve the entire record collection and display it in the lookup pop-up box. */                esq.getEntityCollection(function(result) {                    var existsDocumentsCollection = [];                    if (result.success) {                        result.collection.each(function(item) {                            existsDocumentsCollection.push(item.get("DocumentId"));                        });                    }                    /* Add the filter to the configuration object. */                    if (existsDocumentsCollection.length > 0) {                        var existsFilter = this.Terrasoft.createColumnInFilterWithParameters("Id",                            existsDocumentsCollection);                        existsFilter.comparisonType = this.Terrasoft.ComparisonType.NOT_EQUAL;                        existsFilter.Name = "existsFilter";                        config.filters = existsFilter;                    }                    /* Call the lookup pop-up box. */                    this.openLookup(config, this.addCallBack, this);                }, this);            },            /* Record pageâ€™s save event handler. */            onCardSaved: function() {                this.openDocumentLookup();            },            /* Open the document lookup if the order page has been saved earlier. */            addRecord: function() {                var masterCardState = this.sandbox.publish("GetCardState", null, [this.sandbox.id]);                var isNewRecord = (masterCardState.state === configurationEnums.CardStateV2.ADD ||                masterCardState.state === configurationEnums.CardStateV2.COPY);                if (isNewRecord === true) {                    var args = {                        isSilent: true,                        messageTags: [this.sandbox.id]                    };                    this.sandbox.publish("SaveRecord", args, [this.sandbox.id]);                    return;                }                this.openDocumentLookup();            },            /* Add the selected products. */            addCallBack: function(args) {                /* The instance of the BatchQuery batch query class. */                var bq = this.Ext.create("Terrasoft.BatchQuery");                var OrderId = this.get("MasterRecordId");                /* The collection of documents selected in the lookup. */                this.selectedRows = args.selectedRows.getItems();                /* The collection to pass to the query. */                this.selectedItems = [];                /* Copy the needed data. */                this.selectedRows.forEach(function(item) {                    item.OrderId = OrderId;                    item.DocumentId = item.value;                    bq.add(this.getDocumentInsertQuery(item));                    this.selectedItems.push(item.value);                }, this);                /* Execute the batch query if it is not empty. */                if (bq.queries.length) {                    this.showBodyMask.call(this);                    bq.execute(this.onDocumentInsert, this);                }            },            /* Return the query to add the current object. */            getDocumentInsertQuery: function(item) {                var insert = Ext.create("Terrasoft.InsertQuery", {                    rootSchemaName: this.entitySchemaName                });                insert.setParameterValue("UsrOrder", item.OrderId, this.Terrasoft.DataValueType.GUID);                insert.setParameterValue("UsrDocument", item.DocumentId, this.Terrasoft.DataValueType.GUID);                return insert;            },            /* The method to call when adding records to the detail list. */            onDocumentInsert: function(response) {                this.hideBodyMask.call(this);                this.beforeLoadGridData();                var filterCollection = [];                response.queryResults.forEach(function(item) {                    filterCollection.push(item.id);                });                var esq = Ext.create("Terrasoft.EntitySchemaQuery", {                    rootSchemaName: this.entitySchemaName                });                this.initQueryColumns(esq);                esq.filters.add("recordId", Terrasoft.createColumnInFilterWithParameters("Id", filterCollection));                /* Create a view model. */                esq.on("createviewmodel", this.createViewModel, this);                esq.getEntityCollection(function(response) {                    this.afterLoadGridData();                    if (response.success) {                        var responseCollection = response.collection;                        this.prepareResponseCollection(responseCollection);                        this.getGridData().loadAll(responseCollection);                    }                }, this);            },            /* The method to call when deleting the selected detail records. */            deleteRecords: function() {                var selectedRows = this.getSelectedItems();                if (selectedRows.length > 0) {                    this.set("SelectedRows", selectedRows);                    this.callParent(arguments);                }            },            /* Hide the Copy menu item. */            getCopyRecordMenuItem: Terrasoft.emptyFn,            /* Hide the Edit menu item. */            getEditRecordMenuItem: Terrasoft.emptyFn,            /* Return the name of the default column for the filter. */            getFilterDefaultColumnName: function() {                return "UsrDocument";            }        },        /* The array of modifications. */        diff: /**SCHEMA_DIFF*/[            {                /* Set the operation type to merge. */                "operation": "merge",                /* The name of the schema element on which to execute the operation. */                "name": "DataGrid",                /* The object whose properties to merge with the schema element properties. */                "values": {                    "rowDataItemMarkerColumnName": "UsrDocument"                }            },            {                /* Set the operation type to merge. */                "operation": "merge",                /* The name of the schema element on which to execute the operation. */                "name": "AddRecordButton",                /* The object whose properties to merge with the schema element properties. */                "values": {                    "visible": {"bindTo": "getToolsVisible"}                }            }        ]/**SCHEMA_DIFF*/    };});